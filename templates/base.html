<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}JKB Finance Insights Terminal{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body class="terminal-body">
    <nav class="navbar navbar-expand-lg navbar-dark terminal-nav">
        <div class="container-fluid">
            <a class="navbar-brand terminal-brand" href="/">
                <i class="bi bi-terminal"></i>
                JKB Finance Terminal
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="symbolsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-list-ul"></i> RECENTS
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark" id="symbolsDropdownMenu" aria-labelledby="symbolsDropdown">
                        <li><div class="dropdown-header">Loading symbols...</div></li>
                    </ul>
                </div>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="utilitiesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-tools"></i> UTILITIES
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark" id="utilitiesDropdownMenu" aria-labelledby="utilitiesDropdown">
                        <li><div class="dropdown-header">Server Utilities</div></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="fetch_all" data-symbol="BTCUSD" data-exchange="BITSTAMP">
                            <i class="bi bi-download"></i> Fetch All Feeds
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="analyze_all">
                            <i class="bi bi-robot"></i> AI Analyze All
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="cleanup_tasks">
                            <i class="bi bi-trash"></i> Cleanup Old Tasks
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="reset_stuck_tasks">
                            <i class="bi bi-arrow-clockwise"></i> Reset Stuck Tasks
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="cleanup_reports">
                            <i class="bi bi-file-earmark-x"></i> Cleanup Old Reports
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="reset_queue">
                            <i class="bi bi-arrow-repeat"></i> Reset Task Queue
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="get_stats">
                            <i class="bi bi-graph-up"></i> System Stats
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="get_status">
                            <i class="bi bi-info-circle"></i> Task Status
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><div class="dropdown-header">Advanced Features</div></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="open_dashboard">
                            <i class="bi bi-speedometer2"></i> Real-time Dashboard
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="system_monitor">
                            <i class="bi bi-activity"></i> System Monitor
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="database_backup">
                            <i class="bi bi-database-check"></i> Database Backup
                        </a></li>
                        <li><a class="dropdown-item utility-item" href="#" data-command="export_data">
                            <i class="bi bi-file-earmark-arrow-down"></i> Export Data
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <main class="container-fluid terminal-main">
        {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/debugger.js"></script>
    
    <script>
        /**
         * 
         * ┌─────────────────────────────────────┐
         * │        SYMBOLS DROPDOWN            │
         * └─────────────────────────────────────┘
         * Populate symbols dropdown with data from API
         * 
         * Fetches normalized symbols from the insights API
         * and populates the dropdown menu with clickable links.
         */
        async function populateSymbolsDropdown() {
            try {
                const response = await fetch('/api/symbols');
                const data = await response.json();
                
                if (data.success && data.symbols) {
                    const dropdownMenu = document.getElementById('symbolsDropdownMenu');
                    
                    // Clear loading message
                    dropdownMenu.innerHTML = '';
                    
                    if (data.symbols.length === 0) {
                        dropdownMenu.innerHTML = '<li><div class="dropdown-header">No symbols found</div></li>';
                        return;
                    }
                    
                    // Add symbols to dropdown
                    data.symbols.forEach(symbolData => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        
                        link.className = 'dropdown-item';
                        link.href = symbolData.url;
                        link.innerHTML = `
                            <div class="symbol-content">
                                <span class="symbol-text">${symbolData.symbol}</span>
                                <span class="exchange-tag">${symbolData.exchange}</span>
                            </div>
                        `;
                        
                        listItem.appendChild(link);
                        dropdownMenu.appendChild(listItem);
                    });
                    
                    // Add separator and database utilities
                    const separator = document.createElement('li');
                    separator.innerHTML = '<hr class="dropdown-divider">';
                    dropdownMenu.appendChild(separator);
                    
                    // Add database utilities header
                    const dbHeader = document.createElement('li');
                    dbHeader.innerHTML = '<div class="dropdown-header">Database Utilities</div>';
                    dropdownMenu.appendChild(dbHeader);
                    
                    // Add database utility items
                    const dbUtilities = [
                        { command: 'reset_failed_ai', icon: 'bi-arrow-clockwise', text: 'Reset Failed AI Analysis' },
                        { command: 'reset_processing_ai', icon: 'bi-hourglass-split', text: 'Reset Processing AI' },
                        { command: 'cleanup_insights', icon: 'bi-trash', text: 'Cleanup Old Insights' },
                        { command: 'export_data', icon: 'bi-download', text: 'Export Database' },
                        { command: 'import_data', icon: 'bi-upload', text: 'Import Database' }
                    ];
                    
                    dbUtilities.forEach(util => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        
                        link.className = 'dropdown-item utility-item';
                        link.href = '#';
                        link.dataset.command = util.command;
                        link.innerHTML = `
                            <i class="bi ${util.icon}"></i>
                            <span>${util.text}</span>
                        `;
                        
                        listItem.appendChild(link);
                        dropdownMenu.appendChild(listItem);
                    });
                    

                    
                } else {
                    console.error('Failed to load symbols:', data.error || 'Unknown error');
                    const dropdownMenu = document.getElementById('symbolsDropdownMenu');
                    dropdownMenu.innerHTML = '<li><div class="dropdown-header text-danger">Error loading symbols</div></li>';
                }
            } catch (error) {
                console.error('Error fetching symbols:', error);
                const dropdownMenu = document.getElementById('symbolsDropdownMenu');
                dropdownMenu.innerHTML = '<li><div class="dropdown-header text-danger">Failed to load symbols</div></li>';
            }
        }
        
        // Populate dropdown when page loads
        document.addEventListener('DOMContentLoaded', populateSymbolsDropdown);
        
        /**
         * 
         * ┌─────────────────────────────────────┐
         * │        UTILITIES DROPDOWN           │
         * └─────────────────────────────────────┘
         * Handle utility command execution
         * 
         * Executes server-side commands when utility items are clicked.
         * All commands use existing API endpoints and functions.
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers for utility items
            document.addEventListener('click', async function(e) {
                if (e.target.closest('.utility-item')) {
                    e.preventDefault();
                    const item = e.target.closest('.utility-item');
                    const command = item.dataset.command;
                    const symbol = item.dataset.symbol;
                    const exchange = item.dataset.exchange;
                    
                    // Show loading state
                    const originalText = item.innerHTML;
                    item.innerHTML = '<i class="bi bi-hourglass-split"></i> Executing...';
                    item.style.pointerEvents = 'none';
                    
                    try {
                        let result;
                        
                        switch (command) {
                            case 'fetch_all':
                                result = await fetch('/api/scraping/fetch', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        symbol: symbol || 'BTCUSD',
                                        exchange: exchange || 'BITSTAMP',
                                        feed_type: 'ALL',
                                        max_items: 50
                                    })
                                });
                                break;
                                
                            case 'analyze_all':
                                result = await fetch('/api/analysis/analyze', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({})
                                });
                                break;
                                
                            case 'cleanup_tasks':
                                result = await fetch('/api/tasks/cleanup?days=7', { method: 'POST' });
                                break;
                                
                            case 'reset_stuck_tasks':
                                result = await fetch('/api/queue/reset', { method: 'POST' });
                                break;
                                
                            case 'cleanup_reports':
                                result = await fetch('/api/reports/cleanup?days=30', { method: 'POST' });
                                break;
                                
                            case 'reset_queue':
                                result = await fetch('/api/queue/reset', { method: 'POST' });
                                break;
                                
                            case 'get_stats':
                                result = await fetch('/api/tasks/stats');
                                break;
                                
                            case 'get_status':
                                result = await fetch('/api/tasks/status');
                                break;
                                
                            case 'open_dashboard':
                                // Open dashboard in new window
                                window.open('/utilities/dashboard', '_blank', 'width=1400,height=900');
                                item.innerHTML = '<i class="bi bi-check-circle"></i> Dashboard Opened!';
                                item.style.color = '#28a745';
                                setTimeout(() => {
                                    item.innerHTML = originalText;
                                    item.style.color = '';
                                    item.style.pointerEvents = '';
                                }, 2000);
                                return;
                                
                            case 'system_monitor':
                                result = await fetch('/api/utilities/system-metrics');
                                break;
                                
                            case 'database_backup':
                                result = await fetch('/api/utilities/database-backup', { method: 'POST' });
                                break;
                                
                            case 'export_data':
                                result = await fetch('/api/utilities/export-data?format=json');
                                break;
                                
                            default:
                                throw new Error(`Unknown command: ${command}`);
                        }
                        
                        const data = await result.json();
                        
                        // Show success message
                        item.innerHTML = '<i class="bi bi-check-circle"></i> Success!';
                        item.style.color = '#28a745';
                        
                        // Log result to console for debugging
                        console.log(`Utility command ${command} executed:`, data);
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            item.innerHTML = originalText;
                            item.style.color = '';
                            item.style.pointerEvents = '';
                        }, 2000);
                        
                    } catch (error) {
                        console.error(`Utility command ${command} failed:`, error);
                        
                        // Show error message
                        item.innerHTML = '<i class="bi bi-x-circle"></i> Failed!';
                        item.style.color = '#dc3545';
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            item.innerHTML = originalText;
                            item.style.color = '';
                            item.style.pointerEvents = '';
                        }, 2000);
                    }
                }
            });
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
