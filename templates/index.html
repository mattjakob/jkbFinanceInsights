{% extends "base.html" %}

{% block title %}JKB Finance Terminal{% endblock %}

{# Macro for type icons #}
{% macro type_icon(insight_type, description) -%}
    {% if insight_type == 'TD NEWS' %}
        <i class="bi bi-file-text type-icon type-document" title="{{ description or insight_type }}"></i>
    {% elif insight_type == 'TD OPINIONS' %}
        <i class="bi bi-chat-text type-icon type-analysis" title="{{ description or insight_type }}"></i>
    {% elif 'IDEAS' in insight_type %}
        <i class="bi bi-lightbulb type-icon type-document" title="{{ description or insight_type }}"></i>
    {% else %}
        <i class="bi bi-geo-alt type-icon type-location" title="{{ description or insight_type }}"></i>
    {% endif %}
{%- endmacro %}

{# Macro for action badges #}
{% macro action_badge(action) -%}
    {% if 'SELL' in action|upper %}
        <span class="action-badge action-sell">SELL <i class="bi bi-graph-down-arrow"></i></span>
    {% elif 'BUY' in action|upper %}
        <span class="action-badge action-buy">BUY <i class="bi bi-graph-up-arrow"></i></span>
    {% elif 'HOLD' in action|upper %}
        <span class="action-badge action-hold">HOLD <i class="bi bi-hourglass-split"></i></span>
    {% else %}
        <span class="action-badge action-neutral">{{ action[:4]|upper }}</span>
    {% endif %}
{%- endmacro %}

{# Macro for loading spinner #}
{% macro loading_spinner() -%}
    <div class="loading-spinner"></div>
{%- endmacro %}

{# Macro for AI analysis status indicators #}
{% macro ai_status_indicator(status, content=None) -%}
    {% if status == 'pending' %}
        <div class="ai-status-pending">
            <span class="status-spinner-wrapper">
                <div class="loading-spinner pending"></div>
            </span>
        </div>
    {% elif status == 'processing' %}
        <div class="ai-status-processing">
            <span class="status-spinner-wrapper">
                <div class="loading-spinner processing"></div>
            </span>
        </div>
    {% elif status == 'failed' %}
        <div class="ai-status-failed">
            <span class="status-icon-wrapper">
                <i class="bi bi-x-circle"></i>
            </span>
        </div>
    {% elif status == 'empty' %}
        <div class="ai-status-empty">
            <span class="status-placeholder">-</span>
        </div>
    {% elif status == 'completed' and content %}
        <div class="ai-status-completed">
            <span class="status-content">{{ content }}</span>
        </div>
    {% else %}
        <div class="ai-status-empty">
            <span class="status-placeholder">-</span>
        </div>
    {% endif %}
{%- endmacro %}

{% block content %}
<div class="trading-chart-section mb-4">
    <!-- TradingView Widget BEGIN -->
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget" id="tradingview_widget_container"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript" src="/static/tradingview-chart.js"></script>
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Get initial values from template variables
            const initialSymbol = '{{ selected_symbol or "" }}';
            const initialExchange = '{{ selected_exchange or "" }}';
            
            // Get configuration from template
            const appConfig = {
                UI_REFRESH: {{ config.UI_REFRESH }},
                frontend_unified_refresh_interval: {{ config.frontend_unified_refresh_interval }},
                frontend_age_refresh_interval: {{ config.frontend_age_refresh_interval }},
                UI_REFRESH_TABLE: {{ config.UI_REFRESH_TABLE }},
                frontend_status_refresh_interval: {{ config.frontend_status_refresh_interval }},
                app_reload_delay: {{ config.app_reload_delay }},
                app_max_items: {{ config.app_max_items }},
                app_search_debounce: {{ config.app_search_debounce }},
                app_auto_refresh: {{ config.app_auto_refresh|lower }},
                tradingview_chart_height: {{ config.tradingview_chart_height }},
                tradingview_chart_interval: '{{ config.tradingview_chart_interval }}',
                tradingview_chart_timezone: '{{ config.tradingview_chart_timezone }}'
            };
            
            // Make config available globally
            window.AppConfig = appConfig;
            
            // Only initialize chart if both values are provided
            if (initialSymbol && initialExchange) {
                const tradingViewSymbol = `${initialExchange}:${initialSymbol}`;
                TradingViewChart.initialize('tradingview_widget_container', tradingViewSymbol);
            }
        });
        </script>
    </div>
    <!-- TradingView Widget END -->
</div>





<!-- Control Panel -->
<div class="control-panel mb-4">
    <div class="row g-2 align-items-center">
        <!-- Symbol and Exchange Group -->
        <div class="col-auto">
            <div class="symbol-exchange-container">
                <div class="composite-field">
                    <div class="symbol-input-wrapper">
                        <input type="text" class="form-control" 
                               id="symbolInput" 
                               title="Trading Symbol" 
                               placeholder="SYMBOL" 
                               value="{{ selected_symbol or '' }}"
                               pattern="[A-Za-z0-9]{2,20}"
                               autocomplete="off"
                               data-bs-toggle="tooltip"
                               data-bs-placement="bottom"
                               data-bs-title="Enter a trading symbol (e.g., BTCUSD, AAPL)">
                        <div class="autocomplete-dropdown" id="symbolSuggestions"></div>
                    </div>
                    <span class="composite-separator">:</span>
                    <input type="text" class="form-control" 
                           id="exchangeInput" 
                           title="Trading Exchange" 
                           placeholder="EXCHANGE" 
                           value="{{ selected_exchange or '' }}"
                           autocomplete="off"
                           data-bs-toggle="tooltip"
                           data-bs-placement="bottom"
                           data-bs-title="Enter an exchange (e.g., BINANCE, NASDAQ)">
                </div>
            </div>
        </div>


        <!-- Feed Type Filter -->
        <div class="col-auto">
            <div class="composite-field">
                <span class="composite-label">TYPE</span>
                <select class="form-select form-select-sm" id="typeFilter" title="Feed Type">
                    <option value="" {% if selected_type == "" %}selected{% endif %}>ALL</option>
                    {% for feed in feed_names %}
                    <option value="{{ feed.name }}" {% if selected_type == feed.name %}selected{% endif %}>{{ feed.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Settings Group -->
        <div class="col-auto">
            <div class="composite-field">
                <span class="composite-label">INTERVAL</span>
                <select class="form-select form-select-sm" title="Update Interval">
                    <option value="5" selected>5s</option>
                    <option value="30">30s</option>
                    <option value="60">1m</option>
                    <option value="900">15m</option>
                    <option value="1800">30m</option>
                </select>
            </div>
        </div>
        <div class="col-auto">
            <div class="composite-field">
                <span class="composite-label">ITEMS</span>
                <select class="form-select form-select-sm" title="Number of Items">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>

        <!-- Action Group -->
        <div class="col-auto ms-auto">
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-primary btn-sm fetch-btn">FETCH</button>
                <button class="btn btn-primary btn-sm update-btn">ANALYZE</button>
                <button class="btn btn-primary btn-sm generate-btn">GENERATE</button>
                <button class="btn btn-primary btn-sm delete-btn">DELETE</button>
                <a href="/add" class="btn btn-primary btn-sm add-entry-btn">
                    <i class="bi bi-plus-circle"></i> ADD ENTRY
                </a>
            </div>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="status-bar mb-4">
    <div class="status-bar-content" id="statusBarContent">
        <span class="status-time" id="statusTime">{{ current_time.strftime('%H:%M:%S') }}</span>
        <div class="status-tasks-group">
            <span class="status-task-item" id="statusRunning">
                <i class="bi bi-lightning-charge-fill"></i>
                <span class="task-count">{{ task_stats.processing|default(0) }}</span>
            </span>
            <span class="status-task-item" id="statusQueued">
                <i class="bi bi-list-ol"></i>
                <span class="task-count">{{ task_stats.pending|default(0) }}</span>
            </span>
            <span class="status-task-item" id="statusFailed">
                <i class="bi bi-heartbreak-fill"></i>
                <span class="task-count">{{ task_stats.failed|default(0) }}</span>
            </span>
        </div>
        <div class="status-status-group">
            <span class="status-icon" id="statusIcon">
                <i class="bi bi-terminal"></i>
            </span>
            <div class="status-message-container">
                <span class="status-message" id="statusMessage"></span>
                <button class="status-dropdown-toggle" id="statusDropdownToggle" title="Show recent messages">
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="status-dropdown" id="statusDropdown">
                    <div class="status-dropdown-header">Recent Messages</div>
                    <div class="status-dropdown-content" id="statusDropdownContent">
                        <div class="status-dropdown-item">No messages yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Generate Block -->
<div class="generate-block mb-3 d-none" id="generateBlock">
    <div class="terminal-section">
        <div class="section-header clickable" onclick="document.getElementById('generateBlock').classList.add('d-none')" title="Click to hide">
            <span class="section-label">AI MEGASUMMARY</span>
        </div>
        <div class="terminal-content">
            <div id="generateContent">
                <div class="text-center">
                    <div class="spinner-border terminal-spinner" role="status">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <p class="mt-1 mb-1">Generating AI analysis...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Block - Enhanced Visual Design -->
<div class="report-block mb-3 {% if not latest_report %}d-none{% endif %}" id="reportBlock">
    <div class="report-container">
        <div class="report-header">
            <div class="report-title-section">
                <div class="report-badge">
                    <span class="report-icon"><i class="bi bi-calendar-event"></i></span>
                </div>
                <div class="report-symbol-section">
                    <span class="report-time" id="reportTimeFetched">
                        {% if latest_report %}{{ latest_report.timeFetched | format_date }}{% else %}-{% endif %}
                    </span>
                </div>
                <div class="metric-content" id="reportAIAction">
                    {% if latest_report and latest_report.AIAction %}{{ action_badge(latest_report.AIAction) }}{% else %}-{% endif %}
                </div>
            </div>
        </div>
        
        <div class="report-content" id="reportContent">
            <div class="summary-section">
                <div class="summary-text" id="reportAISummary">
                    {% if latest_report and latest_report.AISummary %}{{ latest_report.AISummary }}{% else %}No AI summary available{% endif %}
                </div>
            </div>
            
            <div class="levels-section" id="reportAILevels">
                {% if latest_report and latest_report.AILevels %}
                    <div class="ai-levels-container">
                        {% set levels_parts = latest_report.AILevels.split(' | ') %}
                        <div class="row g-2">
                            {% for level_part in levels_parts %}
                                {% set level_type = level_part.split(':')[0].strip() %}
                                {% set level_values = level_part.split(':')[1].strip() if ':' in level_part else '' %}
                                {% if level_type in ['Entry', 'E', 'TP', 'SL', 'S', 'R'] and level_values %}
                                <div class="col-auto">
                                    <div class="level-badge">
                                        <div class="level-type">
                                            {% if level_type == 'E' %}ENTRY
                                            {% elif level_type == 'TP' %}TAKE_PROFIT
                                            {% elif level_type == 'SL' %}STOP_LOSS
                                            {% elif level_type == 'S' %}SUPPORT
                                            {% elif level_type == 'R' %}RESISTANCE
                                            {% else %}{{ level_type }}
                                            {% endif %}
                                        </div>
                                        <div class="level-values" data-level-value="{{ level_values }}">{{ level_values }}</div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <div class="metrics-section">
                
                <div class="metrics-grid">
                    
                    <div class="metric-card confidence-card">
                        <div class="metric-header">
                            <span class="metric-icon">%</span>
                            <span class="metric-title">CONFIDENCE</span>
                        </div>
                        <div class="metric-content confidence-value" id="reportAIConfidence">
                            {% if latest_report and latest_report.AIConfidence is not none %}{{ "%.0f%%"|format(latest_report.AIConfidence * 100) }}{% else %}-{% endif %}
                        </div>
                    </div>
                    
                    <div class="metric-card event-card">
                        <div class="metric-header">
                            <span class="metric-icon">⏰</span>
                            <span class="metric-title">EVENT TIME</span>
                        </div>
                        <div class="metric-content" id="reportAIEventTime">
                            {% if latest_report and latest_report.AIEventTime %}{{ latest_report.AIEventTime | format_date }}{% else %}-{% endif %}
                        </div>
                    </div>
                    
                    <div class="metric-card status-card">
                        <div class="metric-header">
                            <span class="metric-icon">●</span>
                            <span class="metric-title">STATUS</span>
                        </div>
                        <div class="metric-content status-indicator" id="reportAIAnalysisStatus">
                            {% if latest_report and latest_report.TaskStatus %}{{ latest_report.TaskStatus|upper }}{% else %}-{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if insights %}
    <div class="table-responsive">
        <table class="table finance-table">
            <thead>
                <tr>
                    <th>TYPE</th>
                    <th>SYMBOL</th>
                    <th>AGE</th>
                    <th>TITLE</th>
                    <th>AI SUMMARY</th>
                    <th>ACTION</th>
                    <th>RELEVANCE</th>
                    <th>HORIZON</th>
                    <th>LEVELS</th>
                </tr>
            </thead>
            <tbody id="insightsTableBody">
                {% for insight in insights %}
                <tr class="insight-row" data-insight-id="{{ insight.id }}">
                    <td class="type-col">
                        {{ type_icon(insight.type, insight.feed_description) }}
                    </td>
                    <td class="symbol-col">
                        {% if insight.symbol %}
                            <strong class="symbol">{{ insight.symbol }}</strong>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="age-col">
                        <span class="age-text" data-time-posted="{{ insight.timePosted }}">-</span>
                    </td>
                    <td class="title-col">
                        <div class="title-content" title="Insight ID: {{ insight.id }}">
                            <strong>{{ insight.title[:80] }}{% if insight.title|length > 80 %}...{% endif %}</strong>
                        </div>
                    </td>
                    <td class="summary-col ai-col-left">
                        {{ ai_status_indicator(insight.TaskStatus, insight.AISummary[:100] ~ ('...' if insight.AISummary and insight.AISummary|length > 100 else '') if insight.AISummary else None) }}
                    </td>
                    <td class="action-col ai-col-center">
                        {{ ai_status_indicator(insight.TaskStatus, action_badge(insight.AIAction) if insight.AIAction else None) }}
                    </td>
                    <td class="confidence-col ai-col-center">
                        {{ ai_status_indicator(
                            insight.TaskStatus,
                            ("%.0f%%"|format(insight.AIConfidence * 100)) if insight.TaskStatus == 'completed' and insight.AIConfidence is not none else None
                        ) }}
                    </td>
                    <td class="horizon-col ai-col-center">
                        <span class="horizon-text" data-horizon="{{ insight.AIEventTime or '' }}">
                            {% if insight.AIEventTime %}
                                <span class="horizon-display">-</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </span>
                    </td>
                    <td class="levels-col ai-col-left">
                        <span class="levels-text" data-levels="{{ insight.AILevels or '' }}">
                            {{ ai_status_indicator(insight.TaskStatus, insight.AILevels if insight.AILevels else None) }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <div class="terminal-prompt">

            <span class="prompt-text">No insights found. Run 'fetch' to scrape insights.</span>
        </div>
        
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="/static/js/simple-app.js"></script>
{% endblock %}