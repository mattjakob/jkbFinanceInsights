{% extends "base.html" %}

{% block title %}JKB Finance Terminal{% endblock %}

{% block content %}
<div class="trading-chart-section mb-4">
    <!-- TradingView Widget BEGIN -->
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget" id="tradingview_widget_container"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript" src="/static/tradingview-chart.js"></script>
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            TradingViewChart.initialize('tradingview_widget_container', 'BTCUSD');
        });
        </script>
    </div>
    <!-- TradingView Widget END -->
</div>

<!-- Control Panel -->
<div class="control-panel mb-4">

    <div class="row g-2 align-items-center">
        <!-- Symbol and Exchange Group -->
                <div class="col-auto">
            <div class="symbol-autocomplete-container">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control control-select symbol-input" 
                           id="symbolInput" 
                           title="Trading Symbol" 
                           placeholder="BTCUSD" 
                           value="BTCUSD"
                           pattern="[A-Za-z0-9]{2,20}"
                           autocomplete="off"
                           data-bs-toggle="tooltip"
                           data-bs-placement="bottom"
                           data-bs-title="Enter a trading symbol (e.g., BTCUSD, AAPL)">
                    <span class="input-group-text separator">:</span>
                    <input type="text" class="form-control control-select exchange-input" 
                           id="exchangeInput" 
                           title="Trading Exchange" 
                           placeholder="BINANCE" 
                           autocomplete="off"
                           data-bs-toggle="tooltip"
                           data-bs-placement="bottom"
                           data-bs-title="Enter an exchange (e.g., BINANCE, NASDAQ)">
                    <span class="input-group-text validation-icon" id="symbolValidationIcon">
                        <i class="bi bi-search" id="symbolIcon"></i>
                    </span>
                </div>
                <div class="autocomplete-dropdown" id="symbolAutocomplete">
                    <!-- Autocomplete suggestions will be inserted here -->
                </div>
            </div>
        </div>
        <div class="col-auto">
            <select class="form-select form-select-sm control-select" id="typeFilter" title="Feed Type">
                <option value="" {% if selected_type == "" %}selected{% endif %}>ALL</option>
                {% for feed in feed_names %}
                <option value="{{ feed.name }}" {% if selected_type == feed.name %}selected{% endif %}>{{ feed.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Settings Group -->
        <div class="col-auto">
            <div class="input-group input-group-sm">
                <span class="input-group-text">INTERVAL</span>
                <select class="form-select form-select-sm control-select" title="Update Interval">
                    <option selected>60s</option>
                    <option>5m</option>
                    <option>15m</option>
                    <option>1h</option>
                </select>
            </div>
        </div>
        <div class="col-auto">
            <div class="input-group input-group-sm">
                <span class="input-group-text">ITEMS</span>
                <select class="form-select form-select-sm control-select" title="Number of Items">
                    <option selected>10</option>
                    <option>25</option>
                    <option>50</option>
                    <option>100</option>
                </select>
            </div>
        </div>

        <!-- Action Group - Right Aligned -->
        <div class="col-auto ms-auto">
            <div class="d-flex gap-2 align-items-center">
                <a href="/add" class="btn btn-outline-light btn-sm add-entry-btn">
                    <i class="bi bi-plus-circle"></i> ADD ENTRY
                </a>
                <button class="btn btn-success btn-sm fetch-btn">FETCH</button>
                <button class="btn btn-primary btn-sm update-btn">UPDATE</button>
                <button class="btn btn-danger btn-sm delete-btn">DELETE</button>
                <div class="d-flex align-items-center gap-1">
                    <input type="number" class="form-control form-control-sm reset-id-input" id="resetInsightId" placeholder="ID" min="1">
                    <button class="btn btn-outline-warning btn-sm" id="resetBtn" title="Reset AI fields for the specified insight ID">
                        AI RESET
                    </button>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>

<!-- System Status -->
<div class="status-bar mb-4">
    <span class="status-bar-text" id="statusBarText">[SYSTEM] Loading...</span>
</div>

{% if insights %}
    <div class="table-responsive">
        <table class="table table-dark finance-table">
            <thead>
                <tr>
                    <th>TYPE</th>
                    <th>SYMBOL</th>
                    <th>AGE</th>
                    <th>TITLE</th>
                    <th>AI SUMMARY</th>
                    <th>ACTION</th>
                    <th>RELEVANCE</th>
                    <th>HORIZON</th>
                    <th>LEVELS</th>
                </tr>
            </thead>
            <tbody>
                {% for insight in insights %}
                <tr class="insight-row" data-insight-id="{{ insight.id }}">
                    <td class="type-col">
                        {% if insight.type == 'TD NEWS' %}
                            <i class="bi bi-file-text type-icon type-document" title="{{ insight.feed_description or insight.type }}"></i>
                        {% elif insight.type == 'TD OPINIONS' %}
                            <i class="bi bi-chat-text type-icon type-analysis" title="{{ insight.feed_description or insight.type }}"></i>
                        {% elif 'IDEAS' in insight.type %}
                            <i class="bi bi-lightbulb type-icon type-document" title="{{ insight.feed_description or insight.type }}"></i>
                        {% else %}
                            <i class="bi bi-geo-alt type-icon type-location" title="{{ insight.feed_description or insight.type }}"></i>
                        {% endif %}
                    </td>
                    <td class="symbol-col">
                        {% if insight.symbol %}
                            <strong class="symbol">{{ insight.symbol }}</strong>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="age-col">
                        <span class="age-text" data-time-posted="{{ insight.timePosted }}">-</span>
                    </td>
                    <td class="title-col">
                        <div class="title-content" title="Insight ID: {{ insight.id }}">
                            <strong>{{ insight.title[:80] }}{% if insight.title|length > 80 %}...{% endif %}</strong>
                        </div>
                    </td>
                    <td class="summary-col">
                        {% if insight.AISummary %}
                            {{ insight.AISummary[:100] }}{% if insight.AISummary|length > 100 %}...{% endif %}
                        {% else %}
                            <div class="loading-spinner"></div>
                        {% endif %}
                    </td>
                    <td class="action-col">
                        {% if insight.AIAction %}
                            {% if 'SELL' in insight.AIAction|upper %}
                                <span class="action-badge action-sell">SELL <i class="bi bi-graph-down-arrow"></i></span>
                            {% elif 'BUY' in insight.AIAction|upper %}
                                <span class="action-badge action-buy">BUY <i class="bi bi-graph-up-arrow"></i></span>
                            {% elif 'HOLD' in insight.AIAction|upper %}
                                <span class="action-badge action-hold">HOLD <i class="bi bi-hourglass-split"></i></span>
                            {% else %}
                                <span class="action-badge action-neutral">{{ insight.AIAction[:4]|upper }}</span>
                            {% endif %}
                        {% else %}
                            <div class="loading-spinner"></div>
                        {% endif %}
                    </td>
                    <td class="confidence-col">
                        {% if insight.AIConfidence is not none %}
                            <span class="confidence-value">{{ "%.0f"|format(insight.AIConfidence * 100) }}%</span>
                        {% else %}
                            <div class="loading-spinner"></div>
                        {% endif %}
                    </td>
                    <td class="time-col">
                        {% if insight.AIEventTime %}
                            {{ insight.AIEventTime[-5:] if ':' in insight.AIEventTime else insight.AIEventTime[:5] }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="levels-col">
                        {% if insight.AILevels %}
                            {% set levels_parts = insight.AILevels.split(' | ') %}
                            {% set entry = '' %}
                            {% set take_profit = '' %}
                            {% for level_part in levels_parts %}
                                {% if 'Entry:' in level_part %}
                                    {% set entry = level_part.replace('Entry:', 'E:').strip() %}
                                {% elif 'TP:' in level_part %}
                                    {% set take_profit = level_part.replace('TP:', 'T:').strip() %}
                                {% endif %}
                            {% endfor %}
                            <span class="levels-text">
                                {% if entry %}{{ entry }}{% endif %}
                                {% if entry and take_profit %} | {% endif %}
                                {% if take_profit %}{{ take_profit }}{% endif %}
                                {% if not entry and not take_profit %}{{ insight.AILevels[:50] }}{% endif %}
                            </span>
                            <!-- Debug: {{ insight.AILevels }} -->
                        {% else %}
                            <div class="loading-spinner"></div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <div class="terminal-prompt">
            <span class="prompt-symbol">$</span>
            <span class="prompt-text">No insights found. Run 'add_insight' to create your first entry.</span>
        </div>
        <div class="mt-4 text-center">
            <a href="/add" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> ADD FIRST INSIGHT
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}
