{% extends "base.html" %}

{% block title %}{{ insight.title }} - JKB Finance Terminal{% endblock %}

{% block content %}
<div class="title-table mb-4">
    <div class="title-row-1">
        <div class="type-cell">{{ insight.type }}</div>
        <div class="empty-cell"></div>
    </div>
    <div class="title-row-2">
        <div class="symbol-exchange-cell">{{ insight.symbol or '-' }} / {{ insight.exchange or '-' }}</div>
        <div class="title-cell">{{ insight.title }}</div>
    </div>
</div>

<!-- Control Panel for Actions -->
<div class="control-panel mb-4">
    <div class="row g-2 align-items-center">
        <div class="col-auto">
            <div class="info-button">
                <span class="info-label">ID</span>
                <span class="info-value">{{ insight.id }}</span>
            </div>
        </div>
        <div class="col-auto">
            <div class="info-button">
                <span class="info-label">AGE</span>
                <span class="info-value age-text" data-time-posted="{{ insight.timePosted }}">-</span>
            </div>
        </div>
        {% if insight.AIAction %}
        <div class="col-auto">
            {% if 'SELL' in insight.AIAction|upper %}
                <span class="action-btn action-sell">SELL <i class="bi bi-graph-down-arrow"></i></span>
            {% elif 'BUY' in insight.AIAction|upper %}
                <span class="action-btn action-buy">BUY <i class="bi bi-graph-up-arrow"></i></span>
            {% elif 'HOLD' in insight.AIAction|upper %}
                <span class="action-btn action-hold">HOLD <i class="bi bi-hourglass-split"></i></span>
            {% else %}
                <span class="action-btn action-neutral">{{ insight.AIAction[:4]|upper }}</span>
            {% endif %}
        </div>
        {% endif %}
        {% if insight.AIConfidence is not none %}
        <div class="col-auto">
            <div class="info-button">
                <span class="info-label">RELEVANCE</span>
                <span class="info-value">{{ "%.0f"|format(insight.AIConfidence * 100) }}%</span>
            </div>
        </div>
        {% endif %}
        <div class="col-auto ms-auto">
            <a href="/" class="btn btn-success btn-sm">
                <i class="bi bi-arrow-left"></i> TERMINAL
            </a>
        </div>
 
        <div class="col-auto">
            <button class="btn btn-secondary btn-sm" id="textAnalysisBtn" data-insight-id="{{ insight.id }}">
                <i class="bi bi-stars"></i> STRATEGY
            </button>
        </div>
        
        {% if insight.imageURL %}
        <div class="col-auto">
            <button class="btn btn-secondary btn-sm" id="imageAnalysisBtn" data-insight-id="{{ insight.id }}">
                <i class="bi bi-stars"></i> CHART
            </button>
        </div>
        {% endif %}

        <div class="col-auto">
            <a href="/edit-insight/{{ insight.id }}" class="btn btn-primary btn-sm">
                <i class="bi bi-pencil"></i> EDIT
            </a>
        </div>
        <div class="col-auto">
            <button class="btn btn-danger btn-sm" id="deleteInsightBtn" data-insight-id="{{ insight.id }}">
                <i class="bi bi-trash"></i> DELETE
            </button>
        </div>
    </div>
</div>

<!-- AI Summary Section -->
{% if insight.AISummary %}
<div class="terminal-section mb-4">
    <div class="section-header">
        <span class="section-label">AI SUMMARY</span>

        
    </div>
    <div class="terminal-content">{{ insight.AISummary }}</div>
    
    {% if insight.AIEventTime %}
    <div class="metadata-item" style="margin-top: 1rem;">
        <span class="metadata-key">TIME HORIZON:</span>
        <span class="metadata-value">{{ insight.AIEventTime[:19].replace('T', ' ') }}</span>
    </div>
    {% endif %}


    
    {% if insight.AILevels %}

        <div class="ai-levels-container">
            {% set levels_parts = insight.AILevels.split(' | ') %}
            <div class="row g-2">
                {% for level_part in levels_parts %}
                    {% set level_type = level_part.split(':')[0].strip() %}
                    {% set level_values = level_part.split(':')[1].strip() if ':' in level_part else '' %}
                    {# Show all levels including Entry in detail view #}
                    {% if level_type in ['Entry', 'E', 'TP', 'SL', 'S', 'R'] and level_values %}
                    <div class="col-auto">
                        <div class="level-badge level-{{ level_type.lower() }}">
                            <div class="level-type">
                                {% if level_type == 'E' %}ENTRY
                                {% elif level_type == 'TP' %}TAKE_PROFIT
                                {% elif level_type == 'SL' %}STOP_LOSS
                                {% elif level_type == 'S' %}SUPPORT
                                {% elif level_type == 'R' %}RESISTANCE
                                {% else %}{{ level_type }}
                                {% endif %}
                            </div>
                            <div class="level-values" data-level-value="{{ level_values }}">{{ level_values }}</div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

    {% endif %}
</div>
{% endif %}






<!-- Image Section -->
{% if insight.imageURL %}
<div class="terminal-section mb-4">
    <div class="section-header">
        <span class="section-label">CHART</span>
    </div>
    <img src="{{ insight.imageURL }}" class="img-fluid terminal-image" alt="Insight image">
</div>
{% endif %}

{% if insight.AIImageSummary %}
<!-- TA Section -->
<div class="mb-4">
    <div class="section-header">
        <span class="section-label">AI TECHNICAL ANALYSIS</span>
    </div>
    <div class="terminal-content">{{ insight.AIImageSummary }}</div>
</div>
{% endif %}

<!-- Content Section -->
<div class="mb-4">
    <div class="section-header">
        <span class="section-label">ORIGINAL TEXT</span>
    </div>
    <div class="terminal-content">{{ insight.content }}</div>
</div>

<!-- Metadata Section -->
<div class="terminal-section mb-4">
    <div class="section-header">
        <span class="section-label">METADATA</span>
    </div>
    <div class="section-content">
        <div class="row">
            <div class="col-md-6">
                <div class="metadata-item">
                    <span class="metadata-key">TIME_FETCHED:</span>
                    <span class="metadata-value">{{ insight.timeFetched[:19].replace('T', ' ') }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="metadata-item">
                    <span class="metadata-key">TIME_POSTED:</span>
                    <span class="metadata-value">{{ insight.timePosted[:19].replace('T', ' ') }}</span>
                </div>
            </div>
        </div>
    </div>
</div>


{% block scripts %}
<script type="module">
import { insightsService } from '/static/js/services/insights.js';
import { showNotification } from '/static/js/core/utils.js';

// Format level values as currency
function formatLevelValues() {
    const levelValueElements = document.querySelectorAll('.level-values[data-level-value]');
    
    levelValueElements.forEach(element => {
        const rawValue = element.getAttribute('data-level-value');
        if (rawValue) {
            // Extract numeric value and format as currency
            const numericValue = parseFloat(rawValue.replace(/[^\d.-]/g, ''));
            if (!isNaN(numericValue)) {
                const formattedValue = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(numericValue);
                
                element.textContent = formattedValue;
            }
        }
    });
}

async function handleAITextAnalysis(insightId, buttonElement) {
    const button = buttonElement;
    const originalText = button.innerHTML;
    
    try {
        // Disable button and show loading state
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ANALYZING...';
        button.disabled = true;
        
        // Call AI text analysis service
        const result = await insightsService.performAITextAnalysis(insightId);
        
        Debugger.info('AI text analysis response:', result);
        
        if (result.success) {
            // Reload the page to show updated AI fields
            location.reload();
        } else {
            const errorMessage = result.message || 'Unknown error occurred';
            showNotification(`AI text analysis failed: ${errorMessage}`, 'error');
        }
    } catch (error) {
        Debugger.error('AI text analysis error:', error);
        showNotification('Error performing AI text analysis', 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

async function handleAIImageAnalysis(insightId, buttonElement) {
    const button = buttonElement;
    const originalText = button.innerHTML;
    
    try {
        // Disable button and show loading state
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ANALYZING...';
        button.disabled = true;
        
        // Call AI image analysis service
        const result = await insightsService.performAIImageAnalysis(insightId);
        
        Debugger.info('AI image analysis response:', result);
        
        if (result.success) {
            // Reload the page to show updated AI fields
            location.reload();
        } else {
            const errorMessage = result.message || 'Unknown error occurred';
            showNotification(`AI image analysis failed: ${errorMessage}`, 'error');
        }
    } catch (error) {
        Debugger.error('AI image analysis error:', error);
        showNotification('Error performing AI image analysis', 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

async function handleDeleteInsight(insightId) {
    if (!confirm('Are you sure you want to delete this insight?')) {
        return;
    }
    
    try {
        await insightsService.deleteInsight(insightId, true);
    } catch (error) {
        Debugger.error('Delete insight error:', error);
        showNotification('Error deleting insight', 'error');
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Format level values
    formatLevelValues();
    
    // Add event listeners
    const deleteBtn = document.getElementById('deleteInsightBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const insightId = this.getAttribute('data-insight-id');
            handleDeleteInsight(insightId);
        });
    }
    
    const textAnalysisBtn = document.getElementById('textAnalysisBtn');
    if (textAnalysisBtn) {
        textAnalysisBtn.addEventListener('click', function() {
            const insightId = this.getAttribute('data-insight-id');
            handleAITextAnalysis(insightId, this);
        });
    }
    
    const imageAnalysisBtn = document.getElementById('imageAnalysisBtn');
    if (imageAnalysisBtn) {
        imageAnalysisBtn.addEventListener('click', function() {
            const insightId = this.getAttribute('data-insight-id');
            handleAIImageAnalysis(insightId, this);
        });
    }
});
</script>
{% endblock %}

{% endblock %}
